{% extends "todo_tasks/base.html" %}

{% block title %}
    Добавить задание
{% endblock %}

{% block content %}
    <h2 class="m-3, text-center">Выдать задание</h2>
    <form id="formAdd" method="post">
    {% csrf_token %}
    {{ form.text_task }}
    {{ form.task_type_work }}
    <button type="submit" class="btn btn-success" href="{% url 'add_task' %}">Добавить</button>

 <div class="container">
    <div class="row pt-5">
        <div class="col-6 offset-3">

            <form id="formAdd" action="{% url 'index'  %}" autocomplete="off">
                {% csrf_token %}
                <div class="row">
                    <div class="col-12">
                        <div class="form-group validate">
                            <label for="">Category</label>
                            <select name="category" class="form-control">
                                <option value="">Выбрать объект</option>
                                {% for object in objects %}
                                <option value="{{ object.id }}">{{ object.object_name }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-red text-muted mySpan"></small>
                        </div>
                        <div class="form-group validate">
                            <label for="">Product</label>
                            <select name="product" class="form-control">
                                <option class="after" value="">Выбрать заказ</option>
                            </select>
                            <small class="text-red text-muted mySpan"></small>
                        </div>
                    </div>
                    <div class="col-6">
                        <button type="submit" class="btn btn-primary pl-5 pr-5 btnSave">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block js_stuff %}
    <script>
        $("#formAdd select[name='category']").on('change', function () {
            var $this = $(this);
            if ($this.val() != '') {
                $("#formAdd select[name='product']").find('.after').nextAll().remove();
                $.ajax({
                    url: '/get_contract/' + $this.val(),
                    type: 'GET',
                    success: function (resp) {
                        let options = '';
                        resp.data.forEach(product => {
                            options += '<option value=' + product.id + '>' + product.name + '</option>';
                        });
                        $("#formAdd select[name='category']").find('.after').after(options);
                    },
                    error: function (resp) {
                        console.log('Something went wrong');
                    }
                });
            } else {
                $("#formAdd select[name='product']").find('.after').nextAll().remove();
            }
        });
    </script>
{% endblock %}

